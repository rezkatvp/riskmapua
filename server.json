const TelegramBot = require('node-telegram-bot-api');
const express = require('express');

// Налаштування
const TOKEN = '8182285531:AAHgNJ_KkXUtFNh-dupM2gOY5TmBaqoQ7eE '; // Замініть на ваш токен від BotFather
const CHANNEL_ID = '@air_alert_ua';
const app = express();
const bot = new TelegramBot(TOKEN, { polling: true });

// Список областей
const regions = [
    { name: "Вінницька область", alert: false },
    { name: "Волинська область", alert: false },
    { name: "Дніпропетровська область", alert: false },
    { name: "Донецька область", alert: false },
    { name: "Житомирська область", alert: false },
    { name: "Закарпатська область", alert: false },
    { name: "Запорізька область", alert: false },
    { name: "Івано-Франківська область", alert: false },
    { name: "Київська область", alert: false },
    { name: "Кіровоградська область", alert: false },
    { name: "Луганська область", alert: false },
    { name: "Львівська область", alert: false },
    { name: "Миколаївська область", alert: false },
    { name: "Одеська область", alert: false },
    { name: "Полтавська область", alert: false },
    { name: "Рівненська область", alert: false },
    { name: "Сумська область", alert: false },
    { name: "Тернопільська область", alert: false },
    { name: "Харківська область", alert: false },
    { name: "Херсонська область", alert: false },
    { name: "Хмельницька область", alert: false },
    { name: "Черкаська область", alert: false },
    { name: "Чернівецька область", alert: false },
    { name: "Чернігівська область", alert: false },
    { name: "Автономна Республіка Крим", alert: false }
];

// Обробка повідомлень із каналу
bot.on('channel_post', (msg) => {
    if (msg.chat.id.toString() === CHANNEL_ID) {
        const text = msg.text || '';
        console.log('Отримано повідомлення:', text);
        
        regions.forEach(region => {
            if (text.includes(`Повітряна тривога в ${region.name}`)) {
                region.alert = true;
                console.log(`${region.name}: Тривога`);
            } else if (text.includes(`Відбій повітряної тривоги в ${region.name}`)) {
                region.alert = false;
                console.log(`${region.name}: Відбій`);
            }
        });
    }
});

// API-ендпоінт для отримання статусів тривог
app.get('/api/alerts', (req, res) => {
    res.json(regions);
});

// Запуск сервера
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Сервер запущено на порту ${PORT}`);
});
